<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Distribua seus Atributos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Distribua os Valores Rolados</h1>
        <p>Valores disponíveis: <strong>{{ valores|join(', ') }}</strong></p>
    
        <div id="dados-valores" data-valores="{{ valores|tojson }}"></div>
        
        <form action="/distribuir" method="post">
            {% for atributo in atributos %}
            <div class="form-group">
                <label for="{{ atributo }}">{{ atributo.capitalize() }}:</label>
                <select name="{{ atributo }}" id="{{ atributo }}" class="atributo-select" required>
                    <option value="">--Selecione--</option>
                    {% for valor in valores|sort|unique %}
                    <option value="{{ valor }}">{{ valor }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endfor %}

            <button type="submit">Finalizar Personagem</button>
        </form>
        
        {% if erro %}
            <p style="color: red;"><strong>Erro:</strong> {{ erro }}</p>
        {% endif %}
    </div>
    
    <script>
        const elementoDados = document.getElementById('dados-valores');
        const valoresRolados = JSON.parse(elementoDados.dataset.valores);
        
        const selects = document.querySelectorAll('.atributo-select');

        // 1. Contar quantas vezes cada número foi rolado (nosso "estoque")
        const contagemDisponivel = valoresRolados.reduce((acc, valor) => {
            acc[valor] = (acc[valor] || 0) + 1;
            return acc;
        }, {});

        function atualizarOpcoesDisponiveis() {
            // 2. Contar quantas vezes cada número já foi selecionado nos menus
            const contagemSelecionada = {};
            selects.forEach(select => {
                const valor = select.value;
                if (valor) { // Ignora se a opção for "--Selecione--"
                    contagemSelecionada[valor] = (contagemSelecionada[valor] || 0) + 1;
                }
            });

            // 3. Atualizar a visibilidade de cada opção em cada menu
            selects.forEach(select => {
                const valorAtualDesteSelect = select.value;

                select.querySelectorAll('option').forEach(option => {
                    if (!option.value) return; // Pula a opção "--Selecione--"

                    const valorDaOpcao = option.value;
                    const selecionados = contagemSelecionada[valorDaOpcao] || 0;
                    const disponiveis = contagemDisponivel[valorDaOpcao] || 0;

                    // A opção deve ser escondida se:
                    // - O número de vezes que ela foi selecionada for maior ou igual ao número de vezes que foi rolada
                    // - E ela não for o valor atualmente selecionado DESTE menu específico (para não esconder a própria seleção)
                    if (selecionados >= disponiveis && valorDaOpcao !== valorAtualDesteSelect) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = 'block';
                    }
                });
            });
        }

        // Adiciona um "ouvinte" para o evento de mudança em cada <select>
        selects.forEach(select => {
            select.addEventListener('change', atualizarOpcoesDisponiveis);
        });

        // Chama a função no início para configurar o estado inicial da página
        document.addEventListener('DOMContentLoaded', atualizarOpcoesDisponiveis);
    </script>
</body>
</html>